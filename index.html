<!DOCTYPE html>
<html>
    <head>
        <script type="module">
            import { parse } from 'https://unpkg.com/@vanillaes/csv@3.0.1/index.js';
            window.parse = parse;
        </script>
        <style>
            #modules {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-evenly;
            }
            .module {
                display: flex;
                flex-direction: column;
            }
        </style>
    </head>
    <body>
        <center><h1>Encompix File Parser</h1></center>
        <center><h3>Created by Edmund Pizzarello</h3></center>
        <hr>
        <div id="modules">
            <div class="module">
                <h4>Aged Accounts Receivable</h4>
                <p>Click on the "Choose File" button to upload a file:</p>
                <input id="AARfileUpload" type="file" onchange="fixAARFile()" /><br />
                <p class="content">The "fixed" file will automatically download. No data is stored.</p>
            </div>
            <div class="module">
                <h4>Taxable Revenue Liability</h4>
                <p>Click on the "Choose File" button to upload a file:</p>
                <input id="TRLfileUpload" type="file" onchange="fixTRLFile()" /><br />
                <p class="content">The "fixed" file will automatically download. No data is stored.</p>
            </div>
        </div>
    </body>
    <script>
        function formatTRLData(txt) {
            let formattedData = [];
            let headers = ['Tax Code','Customer Id','Customer Name','Invoice #','Invoice Date','Tax Rate','Gross Revenue','Taxable Revenue','Tax Liability'];
            formattedData.push(headers);
            let data = parse(txt);
            for(let row of data) {
                let nl = [
                row[24],//tax code
                row[26],//customer id
                '"'+row[27]+'"',//customer name
                row[29],//invoice #
                row[30],//invoice date
                row[31],//tax rate
                row[32].replaceAll(",",""),//gross revenue
                row[33].replaceAll(",",""),// taxable revenue
                row[34].replaceAll(",","")//tax liability
                ];
                formattedData.push(nl);
            }
            return formattedData;
        }
        function formatAARData(txt) {
            let formattedData = [];
            let headers = ['Customer','Salesperson','Invoice #','Document Type','Job #','Invoice Date','Due Date','Invoice Amount','Customer PO','Amount Due','Discount'];
            formattedData.push(headers);
            let data = parse(txt);
            let currentCustomer = '';
            let currentSalesperson = '';
            for(let row of data) {
                if(row[0].startsWith('Customer')) {
                    currentCustomer = row[1];
                    currentSalesperson = row[7];
                } else if(row[0].length==0) {
                    let nl = [
                    currentCustomer,
                    currentSalesperson,
                    row[4],//Invoice #
                    row[1],//Document Type
                    row[2],//Job #
                    row[5],//Invoice Date
                    row[9],//Due Date
                    row[8].replaceAll(',',''),//Invoice Amount
                    row[6],//Customer PO
                    row[12].replaceAll(',',''),//Amount Due
                    row[11]//Discount
                    ];
                    for(let c of nl) {
                        if(c.includes(',')) {
                            c = '"'+c+'"';
                        }
                    }
                    formattedData.push(nl);
                }

            }
            return formattedData;
        }
        function downloadAARCSV(data) {
            const blob = new Blob([data],{type:'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href',url);
            let fileInput = document.getElementById('AARfileUpload');
            a.setAttribute('download',fileInput.files[0].name.replace(".csv","-fixed.csv"));
            a.click();
        }
        function downloadTRLCSV(data) {
            const blob = new Blob([data],{type:'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href',url);
            let fileInput = document.getElementById('TRLfileUpload');
            a.setAttribute('download',fileInput.files[0].name.replace(".csv","-fixed.csv"));
            a.click();
        }
        function makeCSV(data) {
            let csv = data.map((item) => {
                var r = item;
                return r.join(",");
            }).join("\n");
            return csv;
        }
        function fixAARFile() {
            const content = document.querySelector(".content");
            const [file] = document.querySelector("input[type=file]#AARfileUpload").files;
            const reader = new FileReader();
          
            reader.addEventListener(
              "load",
              () => {
                // this will then display a text file
                //content.innerText = formatData(reader.result);
                downloadAARCSV(makeCSV(formatAARData(reader.result)));
              },
              false,
            );
          
            if (file) {
              reader.readAsText(file);
            }
          }
          function fixTRLFile() {
              const content = document.querySelector(".content");
              const [file] = document.querySelector("input[type=file]#TRLfileUpload").files;
              const reader = new FileReader();
            
              reader.addEventListener(
                "load",
                () => {
                  // this will then display a text file
                  //content.innerText = formatData(reader.result);
                  downloadTRLCSV(makeCSV(formatTRLData(reader.result)));
                },
                false,
              );
            
              if (file) {
                reader.readAsText(file);
              }
            }
    </script>
</html>
